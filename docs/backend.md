# Backend é–‹ç™ºè¦ç´„ (Next.js API Routes)

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Next.js API Routes, Prisma, Supabase, R2 ã‚’ä½¿ç”¨ã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã«ãŠã‘ã‚‹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ä¿¡é ¼æ€§ã€ç§»æ¤æ€§ã®ãŸã‚ã®è¦ç´„ã‚’å®šç¾©ã—ã¾ã™ã€‚

## 1. ğŸ“œ åŸºæœ¬åŸå‰‡

> **ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä¿¡ç”¨ã™ã‚‹ãªã€‚ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢ã›ã‚ˆã€‚ã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–ã›ã‚ˆã€**

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒã‚¤ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³:** ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ã‚­ãƒ¥ã‚¢ã§ã‚ã‚‹ã‚ˆã†è¨­è¨ˆã—ã¾ã™ï¼ˆèªè¨¼ãƒ»èªå¯ãƒ»æ¤œè¨¼ï¼‰ã€‚
- **ç§»æ¤æ€§:** ç‰¹å®šã®ãƒ™ãƒ³ãƒ€ãƒ¼ï¼ˆSupabaseï¼‰ã«å¼·ãä¾å­˜ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯é¿ã‘ã€å¯èƒ½ãªé™ã‚Šæ¨™æº–çš„ãªæŠ€è¡“ï¼ˆSQL, S3 äº’æ› APIï¼‰ã§å®Ÿè£…ã—ã¾ã™ã€‚
- **å˜ä¸€è²¬ä»»:** API ãƒãƒ³ãƒ‰ãƒ©ã¯ã€ŒHTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã€ã«å°‚å¿µã—ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€Œã‚µãƒ¼ãƒ“ã‚¹å±¤ã€ã«åˆ†é›¢ã—ã¾ã™ã€‚

## 2. ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (æœ€é‡è¦)

- **èªè¨¼:**
  - ä¿è­·ãŒå¿…è¦ãªã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã€**JWT ã®æ¤œè¨¼ã‚’å¿…é ˆ**ã¨ã—ã¾ã™ã€‚
  - æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¾ãŸã¯å…±é€šé–¢æ•°ã«é›†ç´„ã—ã¾ã™ã€‚
- **èªå¯ (Authorization):**
  - **ã€Œèªè¨¼ã€ã¨ã€Œèªå¯ã€ã¯åˆ¥ç‰©**ã§ã™ã€‚èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œä»–äººã®ãƒªã‚½ãƒ¼ã‚¹ã€ã‚’æ“ä½œã§ããªã„ã‹ã€å¿…ãšãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
  - ä¾‹: `DELETE /api/videos/[id]` ã¯ã€`videoId` ã®æ‰€æœ‰è€…ãŒ `auth.userId` ã¨ä¸€è‡´ã™ã‚‹ã‹ã‚’å¿…ãšæ¤œè¨¼ã—ã¾ã™ã€‚
  - **Supabase RLS ã¨ API ã§ã®äºŒé‡ãƒã‚§ãƒƒã‚¯**ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
- **å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:**
  - **Zod** ã®ä½¿ç”¨ã‚’å¿…é ˆã¨ã—ã¾ã™ã€‚
  - `req.body` ã‚„ `req.query` ã‹ã‚‰å—ã‘å–ã£ãŸå€¤ã¯ã€å‡¦ç†ã™ã‚‹å‰ã« **å¿…ãš Zod ã‚¹ã‚­ãƒ¼ãƒã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³** ã—ã¾ã™ã€‚

## 3. ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (Prisma & Supabase)

### 3.1. Prisma ã®å½¹å‰² (ã‚¹ã‚­ãƒ¼ãƒç®¡ç†ã®ã¿)

**ã€æœ€é‡è¦ã€‘** `Prisma Client` ã¯ Edge Runtime ã§ã®å‹•ä½œãŒä¸å®‰å®šãªãŸã‚ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆAPI Routesï¼‰ã§ **`Prisma Client` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¦æ­¢**ã—ã¾ã™ã€‚

Prisma ã¯ã€`schema.prisma` ã§ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ SQL ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**ç”Ÿæˆã™ã‚‹ãŸã‚ã ã‘**ã«ä½¿ç”¨ã—ã¾ã™ã€‚

### 3.2. å¿…é ˆã®é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚)

1.  `schema.prisma` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ï¼‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
2.  ãƒ­ãƒ¼ã‚«ãƒ«ã§ `npx prisma migrate dev` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`migrations/` ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã« SQL ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`migration.sql`ï¼‰ã‚’**ç”Ÿæˆ**ã•ã›ã¾ã™ã€‚
3.  ç”Ÿæˆã•ã‚ŒãŸ `migration.sql` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ï¼ˆ`CREATE TABLE ...`, `ALTER TABLE ...` ç­‰ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
4.  Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚ã‚‹ã€ŒSQL Editorã€ã‚’é–‹ãã€ã‚³ãƒ”ãƒ¼ã—ãŸ SQL ã‚’**æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œ**ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’æ›´æ–°ã—ã¾ã™ã€‚

### 3.3. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ãƒ‡ãƒ¼ã‚¿æ“ä½œ (postgres.js)

- **Next.js Edge Runtime ã®ä½¿ç”¨:**
  - ã™ã¹ã¦ã® API Routes (`/pages/api/*`) ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€`export const runtime = 'edge';` ã‚’å®£è¨€ã—ã€**Edge Runtime** ã§å‹•ä½œã•ã›ã‚‹ã“ã¨ã‚’**å¿…é ˆ**ã¨ã—ã¾ã™ã€‚
- **`postgres.js` ã®ä½¿ç”¨:**
  - API Routes ã‹ã‚‰ Supabase DB ã¸ã®ã‚¯ã‚¨ãƒªå®Ÿè¡Œã¯ã€**`postgres.js`** ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
  - **ç†ç”±:** `postgres.js` ã¯ HTTP/HTTPS çµŒç”±ã§æ¥ç¶šã§ãã€Cloudflare Pages (Edge Runtime) ã§ã®å‹•ä½œãŒå®‰å®šã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚`node-postgres` (pg) ã¯ Node.js ã® `net` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã™ã‚‹ãŸã‚ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚
- **æ¥ç¶šè¨­å®š:**
  - `postgres.js` ã®æ¥ç¶šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€Supabase ã® **pgBouncer**ï¼ˆãƒãƒ¼ãƒˆ `6543`ï¼‰çµŒç”±ã§æ¥ç¶šã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

## 4. ğŸ“¦ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (Cloudflare R2)

- **S3 äº’æ› API ã®ä½¿ç”¨:**
  - R2 ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€**`@aws-sdk/client-s3`** ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- **ç½²åä»˜ã URL (Presigned URL):**
  - å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã€API ãŒã€Œç½²åä»˜ã URLã€ã‚’ç™ºè¡Œã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãã® URL ã«ç›´æ¥ PUT ã™ã‚‹æ–¹å¼ã‚’å³å®ˆã—ã¾ã™ã€‚
- **ã€é‡è¦ã€‘R2 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã® CORS ã‚¨ãƒ©ãƒ¼å¯¾å¿œ:**
  - **å•é¡Œ:** ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰ã‹ã‚‰ç½²åä»˜ã URL ã‚’ä½¿ã£ã¦ R2 ã«ç›´æ¥ `PUT`ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€CORS ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
  - **å¯¾ç­–:** Cloudflare ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€å¯¾è±¡ã® R2 ãƒã‚±ãƒƒãƒˆã®ã€ŒSettingsã€ã‚¿ãƒ–ã‹ã‚‰ **CORS ãƒãƒªã‚·ãƒ¼**ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
  - **è¨­å®šä¾‹ (JSON):**
    ```json
    [
      {
        "AllowedOrigins": [
          "[https://app.example.com](https://app.example.com)",
          "https://*.app.example.com",
          "http://localhost:3000"
        ],
        "AllowedMethods": ["PUT", "POST", "GET"],
        "AllowedHeaders": ["*"],
        "ExposeHeaders": [],
        "MaxAgeSeconds": 3000
      }
    ]
    ```

## 5. ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

- **ã‚µãƒ¼ãƒ“ã‚¹å±¤ (Service Layer) ã®åˆ†é›¢:**

  - API ãƒãƒ³ãƒ‰ãƒ© (`/pages/api/...`) ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç›´æ¥è¨˜è¿°ã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã—ã¾ã™ã€‚
  - ãƒ­ã‚¸ãƒƒã‚¯ã¯ `/services/videoService.ts` ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢ã—ã¾ã™ã€‚

  ```typescript
  // è‰¯ã„ä¾‹
  // /lib/dbClient.ts (postgres.js ã‚’ä½¿ã£ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)
  import postgres from "postgres";

  // Supabase ã® pgBouncer (Transaction mode) ã®æ¥ç¶šæ–‡å­—åˆ—
  const DATABASE_URL = process.env.DATABASE_URL!;

  // Edge Runtime ã§ã‚‚å‹•ä½œã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  export const sql = postgres(DATABASE_URL, {
    ssl: "require",
    max: 1, // ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ã¯æ¥ç¶šã”ã¨ã«ç¢ºç«‹ãƒ»ç ´æ£„ãŒæ¨å¥¨ã•ã‚Œã‚‹
  });

  // /services/videoService.ts
  import { sql } from "@/lib/dbClient";
  export const likeVideo = async (userId: string, videoId: string) => {
    // postgres.js ã¯ SQL ã‚¿ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ¨™æº–
    return await sql`
      INSERT INTO likes (user_id, video_id) 
      VALUES (${userId}, ${videoId})
    `;
  };

  // /pages/api/like.ts
  import * as videoService from "@/services/videoService";

  // Edge Runtime ã‚’å¿…é ˆã«ã™ã‚‹
  export const runtime = "edge";

  export default async function handler(req, res) {
    try {
      const userId = await getUserId(req); // èªè¨¼
      const { videoId } = await validateLikeRequest(req.body); // æ¤œè¨¼ (Zod)

      const like = await videoService.likeVideo(userId, videoId); // â˜…ãƒ­ã‚¸ãƒƒã‚¯å‘¼ã³å‡ºã—

      res.status(200).json({ success: true, data: like[0] });
    } catch (error) {
      handleApiError(error, res); // â˜…ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    }
  }
  ```

  - **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:**
    - API ãƒãƒ³ãƒ‰ãƒ©ã¯å¿…ãš `try...catch` ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã¿ã¾ã™ã€‚
    - `catch` ã—ãŸã‚¨ãƒ©ãƒ¼ã¯ã€ä¸­å¤®ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆ`handleApiError`ï¼‰ã«æ¸¡ã—ã€**Sentry** ã«ãƒ­ã‚°ã‚’é€ä¿¡ã—ã¾ã™ã€‚

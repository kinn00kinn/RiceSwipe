# `gemini.md` (AI 利用ガイドライン)

## 1. 📜 基本原則

- **AI は副操縦士:** Gemini の生成結果を「絶対的な正解」として扱わず、常に「アシスタントによる提案」として扱います。
- **クライアントからの直接呼び出し禁止:** `frontend.md` の規約にも関連しますが、API キー漏洩とコスト管理の観点から、Gemini API は**必ずバックエンド (`/api/...`) 経由で呼び出す**ことを厳守します。
- **責任の明確化:** AI が生成したコンテンツによって生じた問題（例: 間違った情報、権利侵害）の最終的な責任は、我々開発チームとサービスにあることを認識します。

## 2. 🔑 セキュリティとキー管理

- **API キーの管理:** API キーは `process.env.GEMINI_API_KEY` として環境変数で管理し、絶対にコード内にハードコードしません。
- **個人情報 (PII) のマスキング:** ユーザーの氏名、住所、メールアドレス、パスワードなどを**プロンプトに絶対に含めない**ようにします。もし必要な場合は、バックエンド側で必ずマスキング処理（例: `user-123` に置き換え）を行います。

## 3. 💸 コスト管理 (トークノミクス)

- **モデルの選定:** 機能要件に応じて、コストと性能のバランスが取れたモデルを選択します。（例: 高速な応答が必要な場合は `gemini-1.5-flash`、高精度な要約が必要な場合は `gemini-1.5-pro`）
- **トークン上限:**
  - **入力 (Prompt):** 予期せぬ大量の入力を防ぐため、ユーザー入力をプロンプトに組み込む際は、必ず最大文字数（トークン数）でカットオフ処理を行います。
  - **出力 (Response):** `generationConfig` の `maxOutputTokens` を必ず設定し、無限ループや高額課金を防ぎます。
- **レートリミット:**
  - AI 機能を利用する API エンドポイントには、必ず**レートリミット**（例: 1 ユーザーあたり 1 分間に 10 回まで）を実装し、悪用（DDoS 攻撃）による高額課金を防ぎます。

## 4. ✍️ プロンプトエンジニアリング

- **システムプロンプト:**
  - **役割 (Persona):** 「あなたはプロの編集者です」「あなたはフレンドリーなアシスタントです」といった役割を必ず指定します。
  - **出力形式:** JSON、Markdown、特定の文章構造など、レスポンス形式を厳密に指定します。（例: 「必ず JSON オブジェクトのみを返してください」）
- **バージョニング:**
  - プロンプトは `/prompts/summarize.ts` のように、コードとは別のファイルとして管理し、変更履歴を追跡できるようにします。

## 5. 🛡️ レスポンス処理と安全性

- **ハルシネーション対策:**
  - AI の出力を**そのままユーザーに表示しない**ことを原則とします。
  - もしそのまま表示する場合は、必ず「**AI によって生成された可能性があります**」という免責事項を併記します。
- **エラーハンドリング:**
  - Gemini API は `finishReason: 'SAFETY'` や `finishReason: 'RECITATION'`（引用が長すぎる）など、コンテンツがブロックされた場合に特別な理由を返します。
  - API からのエラー（500 系）やタイムアウト、コンテンツブロック発生時に、ユーザーに表示する**フォールバック（代替）レスポンス**を必ず用意します。（例: 「申し訳ありません、現在 AI アシスタントが応答できません」）
- **ストリーミング (Streaming):**
  - 応答に 3 秒以上かかることが想定される機能（例: 長文の生成）では、UX 向上のため `streamGenerateContent` を使用し、**ストリーミング表示**（一文字ずつ表示される）を実装します。

## 6. 📊 ロギングと監視

- **ログ対象:** 以下の項目をログに記録し、コストと品質を監視します。
  - 使用したモデル名
  - 入力トークン数
  - 出力トークン数
  - API 呼び出しのレイテンシ（応答時間）
  - エラーまたはブロックの理由 (`finishReason`)
- **注意:** デバッグ時を除き、**ユーザーの入力（個人情報が含まれる可能性のあるプロンプト）や AI の応答をそのままログに残さない**ようにします。（セキュリティ規約 [2] に準拠）

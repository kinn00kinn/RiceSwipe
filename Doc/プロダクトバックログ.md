# 📱 動画プラットフォーム プロダクトバックログ

## 🚀 エピック 0: 開発基盤 (Foundation & DevOps)

_（最優先で着手すべき、すべての機能の土台となるタスク）_

- [ ] **CI/CD:** GitHub Actions ワークフロー (`ci.yml`) の作成
  - [ ] PR 作成時に自動実行: ①Lint (ESLint), ② 型チェック (tsc), ③ テスト (Vitest/Jest)
  - [ ] `main` ブランチへのマージ時に Cloudflare Pages へ自動デプロイ
- [ ] **データベース:** Prisma の導入と Supabase (Postgres) への接続設定
  - [ ] `schema.prisma` の初期ファイル作成
  - [ ] (NFR: 移植性) Supabase 固有の `supabase-js` ではなく Prisma Client 経由での DB 操作をルール化
- [ ] **ストレージ:** Cloudflare R2 の設定
  - [ ] (NFR: 移植性) S3 互換 API (`@aws-sdk/client-s3`) を使った接続ラッパーモジュールの作成
- [ ] **監視:** Sentry および外部ロギングサービスの設定
  - [ ] (NFR: 監視) Next.js API Routes でのエラーを自動で Sentry に送信する設定
  - [ ] (NFR: 監視) フロントエンドのパフォーマンス監視 (Web Vitals) を Sentry で行う設定
- [ ] **セキュリティ:** Supabase RLS (Row Level Security) の基本ポリシー設定
  - [ ] (NFR: セキュリティ) 「デフォルト拒否 (Deny All)」ポリシーの適用
  - [ ] (NFR: セキュリティ) 認証されたユーザー情報（JWT）を DB に連携するトリガー設定
- [ ] **フロントエンド:** 基本レイアウトと TailwindCSS の設定
  - [ ] (NFR: パフォーマンス) LCP 2.5 秒以内を目指すための基本シェル（ヘッダー、フッター、ナビゲーション）の実装

## 👤 エピック 1: ユーザー認証 (Authentication)

- [ ] **バックエンド:** Supabase Auth (Gmail OAuth) の設定
- [ ] **API:** Next.js API Routes での認証コールバック (`/api/auth/callback`) 実装
- [ ] **フロントエンド:** ログイン / ログアウトボタンと状態管理（React Context / Zustand など）
- [ ] **DB:** `users` テーブルにブラックリスト/ホワイトリスト用のカラム (`status` など) を追加
- [ ] **API:** 認証時にブラックリスト/ホワイトリストを参照し、アクセスを制御するロジックの実装
- [ ] **セキュリティ:** 認証を必要とするページ（マイページなど）のルート保護

## 📤 エピック 2: 動画アップロード (Video Upload)

- [ ] **API:** (NFR: セキュリティ) R2 への動画アップロード用「署名付き URL」を発行する API (`/api/upload/sign`) の実装
- [ ] **フロントエンド:** 動画ファイル選択コンポーネントの実装
- [ ] **フロントエンド:** 署名付き URL を叩き、R2 へ直接アップロードするロジックの実装
- [ ] **フロントエンド:** アップロード中のプログレスバー UI の実装
- [ ] **API:** アップロード完了後、動画のメタデータ（タイトル、ハッシュタグ）を Supabase に保存する API (`/api/videos`) の実装
- [ ] **バックエンド:** (NFR: パフォーマンス) 動画アップロード完了をトリガーに、3 パターンの圧縮動画を生成する Cloudflare Worker（またはバックグラウンド処理）の実装

## 📺 エピック 3: 動画視聴 (Video Playback & Feed)

- [ ] **DB:** `videos` テーブルスキーマの設計 (Prisma)
- [ ] **API:** おすすめ動画フィードを取得する API (`/api/feed`) の実装 (初期はランダムまたは新着順)
- [D] **フロントエンド:** スワイプで動画を切り替えるメイン UI の実装 (例: `react-swipeable`)
- [ ] **フロントエンド:** 動画プレーヤーコンポーネント (再生・停止、プログレスバー)
- [ ] **フロントエンド:** 縦向き・横向き動画のレイアウト自動調整
- [ ] **フロントエンド:** 右スワイプで元動画 URL へ遷移するジェスチャーの実装
- [ ] **NFR 対応:** (NFR: パフォーマンス) TTFF 1.5 秒以内達成のため、次の動画をバックグラウンドで事前読み込み（プリフェッチ）するロジックの実装

## ❤️ エピック 4: インタラクション (Interaction)

- [ ] **DB:** `likes` (user_id, video_id), `lists` (user_id, name, is_public), `list_items` (list_id, video_id) テーブルスキーマの設計
- [ ] **API:** いいね / いいね解除 API (`/api/videos/[id]/like`)
- [ ] **API:** 保存リストの作成 API (`/api/lists`)
- [ ] **API:** 動画をリストに追加 / 削除 API (`/api/lists/[id]/items`)
- [ ] **API:** 共有ボタン（カウントアップ） API (`/api/videos/[id]/share`)
- [ ] **フロントエンド:** いいね・保存・共有ボタンの UI と、押下時の状態（例：いいね済み）を即時反映する処理

## 🔍 エピック 5: 検索 (Search)

- [ ] **DB:** `hashtags` (id, name), `video_hashtag_relations` (video_id, hashtag_id) テーブルスキーマの設計
- [ ] **API:** ハッシュタグ名による動画検索 API (`/api/search/hashtag`)
- [ ] **API:** キーワード（動画タイトル）による動画検索 API (`/api/search/keyword`)
- [ ] **フロントエンド:** 検索バーと検索結果一覧ページの UI
- [ ] **フロントエンド:** 検索条件（例： `#React`）を固定したままスワイプできる UI モードの実装

## 🧠 エピック 6: 推薦 (Recommendation) - v2

_（v1（初期リリース）では必須ではないが、中核機能）_

- [ ] **DB:** `view_history` (user_id, video_id, swipe_action (e.g., 'completed', 'skipped')) テーブルスキーマの設計
- [ ] **API:** スワイプ情報を記録する API (`/api/history`)
- [ ] **バックエンド:** (NFR: スケーラビリティ) 視聴履歴を集計し、ユーザーごとの「好きなハッシュタグ」を計算するバッチ処理（Supabase Function または Worker）
- [ ] **API:** 推薦動画フィード API (`/api/feed/recommended`) の実装 (エピック 3 の API を置き換える)

## 🎨 エピック 7: マイページ (My Page)

- [ ] **API:** 自分がアップロードした動画一覧を取得する API
- [ ] **API:** 自分がいいねした動画一覧を取得する API
- [ ] **API:** 自分の保存リスト一覧（公開・非公開）を取得する API
- [ ] **フロントエンド:** マイページの UI（タブ切り替え:「投稿動画」「いいね」「保存リスト」）の実装

### 前提：ターゲットとする「中規模システム」の定義

まず、目指すべき「中規模」を定量的に定義します。

* **アクティブユーザー数:** 10,000 DAU (Daily Active Users) / 50,000 MAU (Monthly Active Users)
* **APIトラフィック:** ピーク時 **100 RPS** (Requests Per Second)
* **動画再生:** 500,000再生/日
* **データ増加量:** 100,000件/日（いいね・スワイプ履歴など） / 動画アップロード 2GB/日

---

### 1. ⚡️ パフォーマンス・性能要件

**「ユーザーがストレスを感じないこと」**を数値化します。

* **Web Vitals (Core Web Vitals):**
    * **LCP (Largest Contentful Paint):** アプリの初回ロード（シェルの表示）が **2.5秒** 以内であること。
    * **INP (Interaction to Next Paint):** いいねボタンのタップ、スワイプ操作への応答が **100ms** 以内であること。
* **動画再生:**
    * **TTFF (Time to First Frame):** スワイプしてから次の動画の再生が開始されるまでの時間が **1.5秒** 以内であること（事前の圧縮とCDNキャッシュ、バックグラウンドでのプリフェッチを前提とする）。
    * **リバッファ率:** 動画再生中の停止（バッファリング）発生率が全再生の **2%** 未満であること。
* **API応答時間 (P95):** 95%のリクエストが以下の時間内に完了すること。
    * **Read系 (動画フィード取得, 検索):** **200ms** 以内
    * **Write系 (いいね, 保存, アップロード):** **300ms** 以内

---

### 2. 📈 スケーラビリティ・拡張性要件

**「定義した負荷（ピーク100 RPS）を確実に処理できること」**を定義します。

* **ステートレスAPI:** Next.jsのAPI Routesはすべて**ステートレス**であること。ユーザーセッションはJWT（またはそれに類するトークン）で管理し、サーバー側で状態を持たない設計とする。
* **データベース接続:**
    * Supabase（PostgreSQL）の**コネクションプーリング（PgBouncer）**を必ず利用すること。
    * API Routesからデータベースへの直接接続数を最小限に抑えること。
* **キャッシュ戦略:**
    * 頻繁にアクセスされるが更新頻度の低いデータ（例：人気のハッシュタグ一覧、ユーザープロフィール）は、**Cloudflare KV** またはインメモリキャッシュ（`@vercel/kv`のようなライブラリ経由）を導入し、DB負荷を軽減すること。
* **負荷耐性:**
    * 負荷試験において、**100 RPSの負荷を10分間**継続しても、APIエラー率が1%を超えず、P95応答時間が800msを超えないこと。

---

### 3. 🛡️ 可用性要件

**「システムが安定して稼働し続けること」**を定義します。

* **稼働率:** サービス全体の月間稼働率が **99.9%** ("スリーナイン") であること。
    * （許容停止時間：約43分/月）
* **ゼロダウンタイムデプロイ:**
    * Cloudflare Pagesの機能を利用し、フロントエンドの新バージョンデプロイ時に**サービス停止が発生しない**こと。
* **グレースフル・デグラデーション（障害時の縮退運転）:**
    * **Supabase障害時:** 少なくともキャッシュされた動画フィードの閲覧は可能であること（いいね・保存はエラー表示）。
    * **R2障害時:** 動画再生は失敗するが、アプリの基本操作（いいね、コメント閲覧など）は可能であること。

---

### 4. 🔒 セキュリティ要件

**「データとユーザーを保護すること」**を定義します。

* **認証・認可:**
    * 動画アップロードや「いいね」など、個人に紐づくすべてのAPIエンドポイントは、有効なJWTによる認証を必須とすること。
    * **Supabase RLS (Row Level Security)** を**必ず有効**にすること。
        * （例: `users`テーブルは本人のみが`UPDATE`可能、`private_lists`は本人のみが`SELECT`可能）
* **ストレージ (R2):**
    * R2バケットへの**パブリックな書き込みアクセスは絶対に許可しない**こと。
    * 動画アップロードは、Next.js API Routesが発行する**署名付きURL (Presigned URL)** を経由して行うこと。これにより、認証されたユーザーのみが一時的にアップロード権限を得られる。
* **API保護:**
    * **Cloudflare WAF**を有効にし、SQLインジェクション、XSSなどの既知の攻撃をブロックすること。
    * 「いいね」や「アカウント作成」APIには**レートリミット**（例: 1ユーザーあたり10回/分）を設定し、ボットによる攻撃を防ぐこと。

---

### 5. 🛠️ 保守性・移植性要件

**「将来の移行とコード品質」**を定義します。（ご要望の「サーバー移行」に直結します）

* **コード品質 (CIで強制):**
    * `main`ブランチへのマージには、**ESLint**と**Prettier**のチェック通過を必須とすること。
    * `tsc --noEmit`による**TypeScriptの型チェック**が100%通ること。
* **テスト:**
    * **ユニットテスト:** APIの主要なビジネスロジック（推薦ロジック、認証処理など）のカバレッジが **70%** 以上であること。
    * **E2Eテスト:** 「ログイン → スワイプ → いいね → 保存」の主要フローがPlaywrightまたはCypressで自動化されており、デプロイ前に実行されること。
* **移植性（脱ベンダーロックイン）:**
    * **ストレージ (R2):** Cloudflare R2の操作は、**S3互換API（`@aws-sdk/client-s3`）** を使用して実装すること。R2固有のSDKは使用しない。これにより、将来AWS S3やMinIOへの移行がコード変更なしで可能になる。
    * **データベース (Supabase):**
        * データベースアクセスには**Prisma（ORM）**を導入すること。Supabase固有のJSライブラリ（`supabase-js`）によるDB操作は、認証など必要最小限に留める。これにより、将来別のPostgreSQL（例: AWS RDS）への移行が容易になる。
        * SupabaseのAuth機能に依存するロジックは、独自の認証サービス層（API Route）でラップすること。

---

### 6. 📊 運用・監視要件

**「問題の早期発見と原因究明」**を定義します。

* **ロギング:**
    * Next.js API Routesで発生した**全てのエラー**（5xx系）は、スタックトレースを含めて**Sentry**や**Logtail**などの外部ロギングサービスに集約すること。
* **モニタリング:**
    * **Sentry**を導入し、フロントエンド（React）とバックエンド（API）両方のランタイムエラーを監視すること。
    * **Cloudflare Analytics** を利用し、Web VitalsのLCP/INP、APIのエラーレート、キャッシュヒット率をダッシュボードで定常監視すること。
* **アラート:**
    * APIのエラーレートが10分間に**5%**を超えた場合。
    * APIのP95応答時間が1分間以上**1秒**を超え続けた場合。
    * Sentryで**新規のエラー**が検出された場合。
    * 上記の場合、開発チーム（例: Slack, Discord）に自動通知が飛ぶこと。

